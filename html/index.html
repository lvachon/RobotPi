<html>
	<head>
		<style>
			.cmdbtn {font-size:30pt;min-width:4.5cm;min-height:4.5cm}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script>
			keyStates = {};
			function refreshImage(elem,url){
				elem.src = `${url}?rnd=${Math.random()}`;
			}
			function refreshStats(){
				sendCommand("s");
			}
			function sendCommand(cmd){
				
				if(cmd!=="s"){
					Array.from(document.getElementsByClassName("cmdbtn")).forEach(elem=>{elem.disabled=true;});
					statusdiv.innerHTML="Executing...";
				}
				$.post("command.php",{cmd:cmd},function(data){
					data = JSON.parse(data);
					if(data.length){
						statsdiv.innerHTML = data.reduce((acc,elem)=>{
							return acc+=`<br/>${elem}`;
						},"");
					}
					if(cmd!=="s"){
						statusdiv.innerHTML="Done";
						Array.from(document.getElementsByClassName("cmdbtn")).forEach(elem=>{elem.disabled=false;});
					}else{
						setTimeout('refreshStats()',5000);
					}
					
					Object.keys(keyStates).some(key=>{
						if(keyStates[key].state){
							keyStates[key].elem.onclick();
							return true;
						}
						return false;
					});
				});
			}
			function keyDown(e){
				if(keyStates[e.key]){
					if(!keyStates[e.key].state){
						keyStates[e.key].elem.onclick();
					}
					keyStates[e.key].state=true;
				}
			}
			function keyUp(e){
				if(keyStates[e.key]){
					keyStates[e.key].state=false;
				}
			}
		</script>
	</head>
	<body onkeydown='keyDown(event)' onkeyup='keyUp(event)'>
		<center>
			<div>
				<img id='cam' src='ramdisk/frame.jpg' style='width:512px;height:384px;'/>
				<img id='robot' src='ramdisk/robot.jpg' style='width:512px;height:384px;'/>
			</div>
			<div>
				<div id='statusdiv'>Ready</div>
				<div><input type='button' value='FWD' onclick='sendCommand("f");' class='cmdbtn' key='w'/></div>
				<div>
					<input type='button' value='LEFT' onclick='sendCommand("l");' class='cmdbtn' key='a'/>
					<input type='button' value='BWD' onclick='sendCommand("b");' class='cmdbtn' key='s'/>
					<input type='button' value='RIGHT' onclick='sendCommand("r");' class='cmdbtn' key='d'/>
				</div>
				<div>
					<input type='button' value='Enable motors' onclick='sendCommand("e");' class='cmdbtn'/>
					<input type='button' value='Disable motors' onclick='sendCommand("d");' class='cmdbtn'/>
					<input type='button' value='Light on' onclick='sendCommand("l1");' class='cmdbtn'/>
					<input type='button' value='Light off' onclick='sendCommand("l0");' class='cmdbtn'/>
				</div>
				<div id='statsdiv'>Stats...</div>
			</div>
		</center>
	</body>
	<script>
		cam.onload = function(){
			setTimeout('refreshImage(cam,"ramdisk/frame.jpg")',255);
		};
		cam.onerror = cam.onload;
		robot.onload = function(){
			setTimeout('refreshImage(robot,"ramdisk/robot.jpg")',1000);
		};
		robot.onerror = robot.onload;
		Array.from(document.getElementsByTagName("input")).forEach(elem=>{
			if(elem.getAttribute("key")){
				keyStates[elem.getAttribute("key")]={state:false, elem:elem};
			}
		})
		refreshStats();
		refreshImage();
	</script>
</html>


