<html>
	<head>
		<title>Blinky Control Panel</title>
		<style>
			.cmdbtn {font-size:30pt;min-width:3.5cm;min-height:3.5cm}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDc5uUlf9y4jiekICYqu1_AwCr8tSfBEGU&callback=initMap&libraries=&v=weekly" defer></script>
		<script>
			keyStates = {};
			function refreshImage(elem,url){
				elem.src = `${url}?rnd=${Math.random()}`;
			}
			function refreshGPS(){
				$.get("ramdisk/gpsdata",(data)=>{
					try{
						data = JSON.parse(data);
						console.log(data);		
						const d = new Date(data.time*1000);
						gpsElem.innerHTML = `
							<div class='stat'>GPS Time: ${d.toLocaleString()}</div>
							<div class='stat'>Fix: ${data.fix}, Position: ${Math.round(data.lat*1000000)/1000000},${Math.round(data.lon*1000000)/1000000}</div>
							<div class='stat'>Speed: ${Math.round(data.speed*100)/100}m/s, Altitude: ${Math.round(data.alt*100)/100}m</div>
							<div class='stat'>HDOP: ${data.hdop}, Sats: ${data.used}/${Object.keys(data.sats).length}</div>
							<div style='clear:both;'></div>
							<div id='sats' style='float:none;'>`+
								Object.keys(data.sats).map(satKey=>{
									const sat = data.sats[satKey];
									return `<div class='sat' style='left:${sat.azi/3.6}%;bottom:${(sat.ele%90)/90*250}px;background:hsl(${90*sat.snr/45},100%,50%)'>${satKey}</div>`;
								}).join("")+
							`</div>`;
						if(data.lat && data.lon){
							pathPoints.push({lat:data.lat,lng:data.lon});
							path.setPath(pathPoints);
							marker.setPosition({lat:data.lat,lng:data.lon});
							map.panTo(marker.getPosition());
						}
					}catch(e){}
                                        setTimeout(refreshGPS,1000);				
				});
			}
			function refreshStats(){
				sendCommand("s");
			}
			let wait=false;
			function sendCommand(cmd){
				
				if(cmd!=="s"){
					Array.from(document.getElementsByClassName("cmdbtn")).forEach(elem=>{elem.disabled=true;});
					statusdiv.innerHTML="Executing...";
				}
				if(!wait || cmd=="s"){
				   
				   $.post("command.php",{cmd:cmd},function(data){
					if(cmd!="s"){wait=true;}
					data = JSON.parse(data);
					if(data.length){
						statsdiv.innerHTML = data.reduce((acc,elem)=>{
							return acc+=`<div class='stat'>${elem}</div>`;
						},"");
					}
					if(cmd!=="s"){
						statusdiv.innerHTML="Done";
						Array.from(document.getElementsByClassName("cmdbtn")).forEach(elem=>{elem.disabled=false;});
						wait=false;
					}else{
						setTimeout('refreshStats()',5000);
					}
					
					Object.keys(keyStates).some(key=>{
						if(keyStates[key].state){
							keyStates[key].elem.onclick();
							return true;
						}
						return false;
					});
				   });
				}
			}
			function keyDown(e){
				if(keyStates[e.key]){
					if(!keyStates[e.key].state){
						keyStates[e.key].elem.onclick();
					}
					keyStates[e.key].state=true;
				}
			}
			function keyUp(e){
				if(keyStates[e.key]){
					keyStates[e.key].state=false;
				}
			}
		</script>
		<style>
			.container {
                                display: flex;
                                flex-direction:row;
                                width: 100%;
                        }
			@media screen and (max-width: 1440px) {
 			   .container {
			        flex-direction:column;
			    }
			}
			.controls {
				flex-grow: 1;
				flex-shrink: 1;
				display:flex;
				align-items:center;
				flex-direction:column;
				min-width:520px;
			}
			.pics {
				flex-grow: 3;
				flex-shrink: 1;
				flex-direction:column;
			}
			.stat {
				border: solid 1px #BBBBBB;
				background: #333333;
				border-radius:4px;
				margin:4px;
				display:block;
				float:left;
				text-align:center;
				padding:2px;
				white-space:nowrap;

			}
			label{
				display:flex;
				align-items:center;
				flex-direction:column;
			}
			.label{
				display:flex;
				flex-direction:column;
			}
			.stats {
				margin:16px;
				max-width:520px;
			}
			body{
				background:#222222;
				color:#AAAAAA;
				padding: 24px;
			}
			input{
				background:#444444;
				color:#AAAAAA;
			}
			#gpsElem {width:520px;}
			#sats {
				position:relative;
				width:500px;
				height:250px;
				background:#444444;
				border:solid 1px #BBBBBB;
				border-radius:1em;
			}
			.sat {
				position:absolute;
				font-size:12px;
				width:2em;
				height:2em;
				border-radius:1em;
				text-align:center;
				line-height: 2em;
				color:#000000;
				border:solid 1px #000000;
			}
		</style>

	</head>
	<body onkeydown='keyDown(event)' onkeyup='keyUp(event)'>
		<div class='container'>
			<div class='pics'>
				<img id='cam' src='ramdisk/frame.jpg' style='width:100%;flex-grow:2;max-height:768px;'/>
				<img id='robot' src='ramdisk/robot.jpg' style='width:50%;flex-grow:1;'/>
			</div>
			<div class='controls'>
				<div id='statusdiv' >Ready</div>
				<div>
					<input 
						type='button' 
						value='FWD' 
						onclick='sendCommand("f");' 
						ontouchstart='keyStates["w"].state=true;sendCommand("f");' 
						ontouchend='keyStates["w"].state=false;' 
						class='cmdbtn' 
						key='w'
					/>
				</div>
				<div>
					 <input
                                                type='button'
                                                value='LEFT'
                                                onclick='sendCommand("l");'
                                                ontouchstart='keyStates["a"].state=true;sendCommand("l");'
                                                ontouchend='keyStates["a"].state=false;'
                                                class='cmdbtn'
                                                key='a'
                                        />
					 <input
                                                type='button'
                                                value='BACK'
                                                onclick='sendCommand("b");'
                                                ontouchstart='keyStates["s"].state=true;sendCommand("b");'
                                                ontouchend='keyStates["s"].state=false;'
                                                class='cmdbtn'
                                                key='s'
                                        />
					 <input
                                                type='button'
                                                value='RIGHT'
                                                onclick='sendCommand("r");'
                                                ontouchstart='keyStates["d"].state=true;sendCommand("r");'
                                                ontouchend='keyStates["d"].state=false;'
                                                class='cmdbtn'
                                                key='d'
                                        />
				</div>
				<div style='display:flex;flex-direction:row;'>
					<label>
						<input type='checkbox' onchange='this.checked?sendCommand("e"):sendCommand("d");' class='cmdbtn'/>
						<span class='label'>Motors</span>
					</label>
					<label><input type='checkbox' onchange='this.checked?sendCommand("l1"):sendCommand("l0");' class='cmdbtn'/><span class='label'>LED</span></label>
					<label><input type='checkbox' onchange='this.checked?sendCommand("a1"):sendCommand("a0");' class='cmdbtn'/><span class='label'>Automode</span></label>
				</div>
				<div class='stats' id='statsdiv'>Stats...</div>
				<div id='mapDiv' style='min-width:520px;height:320px;width:95%;margin:8px;'></div>
				<div id='gpsElem'>GPS...</div>
			</div>
		</div>
	</body>
	<script>
		let map;
		let path;
		let pathPoints;
		let marker;
		function initMap() {
		  map = new google.maps.Map(document.getElementById("mapDiv"), {
		    center: { lat:42.1078586,lng:-71.0347802 },
		    zoom: 20,
		    mapTypeId: google.maps.MapTypeId.SATELLITE,
		    tilt: 0,
		  });
		  pathPoints = [];
		  path = new google.maps.Polyline({path:pathPoints,strokeColor:"#FF0000"});
		  path.setMap(map);
		  marker = new google.maps.Marker({position:{lat:0,lng:0},map});
		}

		cam.onload = function(){
			setTimeout('refreshImage(cam,"ramdisk/frame.jpg")',255);
		};
		cam.onerror = cam.onload;
		robot.onload = function(){
			setTimeout('refreshImage(robot,"ramdisk/robot.jpg")',1000);
		};
		//robot.onerror = robot.onload;
		Array.from(document.getElementsByTagName("input")).forEach(elem=>{
			if(elem.getAttribute("key")){
				keyStates[elem.getAttribute("key")]={state:false, elem:elem};
			}
		})
		refreshStats();
		//refreshImage();
		refreshGPS();
	</script>
</html>


